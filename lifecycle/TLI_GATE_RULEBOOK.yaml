# =============================================================================
# TLI GATE RULEBOOK
# AIRCRAFT TLI v2.1 Canonical - Gate Logic and Compliance Rules
# Program: AMPEL360 Q100
# Authority: ASIT (Aircraft Systems Information Transponder)
# =============================================================================
#
# This rulebook defines the gate logic for all lifecycle phase transitions.
# Gates are organized into three groups:
#   - Gate Group A: Integrity Gates (structural validity)
#   - Gate Group B: Baseline Gates (baseline production and promotion)
#   - Gate Group C: Certification Continuity (traceability and compliance)
#
# All gates execute sequentially and abort on first failure.
# =============================================================================

meta:
  rulebook_version: "1.0.0"
  program: "AMPEL360 Q100"
  owner: "ASIT"
  status: "ACTIVE"
  last_updated: "2026-02-12"
  compliance:
    - "S1000D Issue 5.0"
    - "DO-178C"
    - "ARP4754A"
    - "ARP4761"

# =============================================================================
# GATE GROUP A — INTEGRITY GATES
# Structural validity and canonical compliance
# =============================================================================

gate_group_a_integrity:
  description: "Structural validity and canonical compliance checks"
  execution_order: 1
  abort_on_failure: true

  gates:
    A1_LC_CODE_VALIDITY:
      gate_id: "A1"
      name: "LC Code Validity"
      description: "Lifecycle code must be in canonical set LC01..LC14"
      rule: "lc_code ∈ {LC01, LC02, LC03, LC04, LC05, LC06, LC07, LC08, LC09, LC10, LC11, LC12, LC13, LC14}"
      enforcement: "block"
      violation_severity: "CRITICAL"
      violation_message: "Invalid lifecycle code - must be LC01 through LC14"
      remediation: "Use only canonical lifecycle codes from LC_PHASE_REGISTRY.yaml"

    A2_PHASE_NAME_CANONICAL:
      gate_id: "A2"
      name: "Phase Name Canonical"
      description: "Phase name must match canonical name for LC code"
      rule: "phase_name == canonical_name(lc_code)"
      enforcement: "block"
      violation_severity: "CRITICAL"
      violation_message: "Phase name does not match canonical name from registry"
      remediation: "Use exact canonical_name from LC_PHASE_REGISTRY.yaml"
      examples:
        - lc_code: "LC02"
          required_name: "System Requirements"
          invalid_names: ["Requirements", "Sys Reqs", "Architecture"]
        - lc_code: "LC04"
          required_name: "Design Definition"
          invalid_names: ["Design", "Detailed Design", "Engineering"]

    A3_PACKAGE_TYPE_ALLOWED:
      gate_id: "A3"
      name: "Package Type Allowed"
      description: "Package type must be in allowed packages for LC code"
      rule: "package_type ∈ allowed_packages(lc_code)"
      enforcement: "block"
      violation_severity: "ERROR"
      violation_message: "Package type not allowed in this lifecycle phase"
      remediation: "Refer to LC_PHASE_REGISTRY.yaml for allowed packages per phase"
      examples:
        - lc_code: "LC02"
          allowed_packages: ["REQ", "ICD", "DATA", "COMPLIANCE_INTENT"]
        - lc_code: "LC04"
          allowed_packages: ["DESIGN", "CONFIG", "INTERFACES"]

    A4_ARTIFACT_PATH_ROOT:
      gate_id: "A4"
      name: "Artifact Path Root"
      description: "Artifact path must start with canonical PLM/OPS root"
      rule: "artifact_path.startswith(canonical_root(lc_code))"
      enforcement: "block"
      violation_severity: "ERROR"
      violation_message: "Artifact path does not start with canonical root directory"
      remediation: "Use PLM root (KDB/LM/SSOT/PLM) for LC01-LC10, OPS root (IDB/OPS/LM) for LC11-LC14"
      path_rules:
        PLM_phases:
          lc_codes: ["LC01", "LC02", "LC03", "LC04", "LC05", "LC06", "LC07", "LC08", "LC09", "LC10"]
          required_root: "KDB/LM/SSOT/PLM"
        OPS_phases:
          lc_codes: ["LC11", "LC12", "LC13", "LC14"]
          required_root: "IDB/OPS/LM"

# =============================================================================
# GATE GROUP B — BASELINE GATES
# Baseline production, exclusivity, and promotion rules
# =============================================================================

gate_group_b_baseline:
  description: "Baseline production, exclusivity, and promotion validation"
  execution_order: 2
  abort_on_failure: true

  gates:
    B1_FBL_EXCLUSIVITY:
      gate_id: "B1"
      name: "FBL Exclusivity"
      description: "Functional Baseline (FBL) allowed only at LC02"
      rule: "if baseline_type == 'FBL' then lc_code == 'LC02'"
      enforcement: "block"
      violation_severity: "CRITICAL"
      violation_message: "FBL can only be produced at LC02 System Requirements"
      remediation: "Move FBL production to LC02 or change baseline type"

    B2_DBL_EXCLUSIVITY:
      gate_id: "B2"
      name: "DBL Exclusivity"
      description: "Design Baseline (DBL) allowed only at LC04"
      rule: "if baseline_type == 'DBL' then lc_code == 'LC04'"
      enforcement: "block"
      violation_severity: "CRITICAL"
      violation_message: "DBL can only be produced at LC04 Design Definition"
      remediation: "Move DBL production to LC04 or change baseline type"

    B3_PBL_EXCLUSIVITY:
      gate_id: "B3"
      name: "PBL Exclusivity"
      description: "Product Baseline (PBL) allowed only at LC10"
      rule: "if baseline_type == 'PBL' then lc_code == 'LC10'"
      enforcement: "block"
      violation_severity: "CRITICAL"
      violation_message: "PBL can only be produced at LC10 Industrial & Supply Chain"
      remediation: "Move PBL production to LC10 or change baseline type"
      constraint: "LC09 cannot host production release authority"

    B4_BASELINE_PROMOTION_TRACE:
      gate_id: "B4"
      name: "Baseline Promotion Trace"
      description: "Baseline promotion must include upstream trace closure"
      rule: "if baseline_promotion then upstream_trace_complete == true"
      enforcement: "block"
      violation_severity: "ERROR"
      violation_message: "Baseline promotion requires complete upstream traceability"
      remediation: "Close all trace links to upstream baseline before promotion"
      trace_chains:
        - chain: "FBL → DBL"
          requirement: "All LC02 requirements must trace to LC04 design elements"
        - chain: "DBL → PBL"
          requirement: "All LC04 design elements must trace through LC06 tests to LC08 compliance and LC10 production"
        - chain: "PBL → OPS"
          requirement: "All LC10 production items must trace to LC11/LC12/LC13 operational artifacts"

# =============================================================================
# GATE GROUP C — CERTIFICATION CONTINUITY
# Traceability and compliance requirements
# =============================================================================

gate_group_c_certification:
  description: "Certification continuity, traceability, and compliance validation"
  execution_order: 3
  abort_on_failure: true

  gates:
    C1_SAFETY_REQUIREMENTS_TRACE:
      gate_id: "C1"
      name: "Safety Requirements Trace"
      description: "LC03 safety artifacts must trace to LC02 requirements"
      rule: "if lc_code == 'LC03' then all(safety_artifacts).trace_to(lc02_requirements)"
      enforcement: "block"
      violation_severity: "CRITICAL"
      violation_message: "Safety artifacts must trace to system requirements (LC02)"
      remediation: "Establish trace links from all safety artifacts to LC02 requirements"
      required_traces:
        - from: "LC03 SAFETY"
          to: "LC02 REQ"
          type: "safety_requirement_trace"
        - from: "LC03 HAZARD_MGMT"
          to: "LC02 REQ"
          type: "hazard_mitigation_trace"

    C2_COMPLIANCE_EVIDENCE_REFS:
      gate_id: "C2"
      name: "Compliance Evidence References"
      description: "LC08 compliance claims require LC06 evidence references"
      rule: "if lc_code == 'LC08' then all(compliance_claims).reference(lc06_evidence)"
      enforcement: "block"
      violation_severity: "CRITICAL"
      violation_message: "Compliance claims must reference verification evidence (LC06)"
      remediation: "Add references to LC06 test results for all compliance claims"
      required_evidence:
        - from: "LC08 COMPLIANCE"
          to: "LC06 TEST"
          type: "compliance_evidence_trace"
        - from: "LC08 CERT_BASIS"
          to: "LC06 CONFORMITY"
          type: "conformity_evidence_trace"

    C3_OPERATIONAL_BASELINE_LINEAGE:
      gate_id: "C3"
      name: "Operational Baseline Lineage"
      description: "LC12/LC13 operational changes must reference certified baseline lineage"
      rule: "if lc_code in ['LC12', 'LC13'] then operational_change.reference(certified_baseline_lineage)"
      enforcement: "block"
      violation_severity: "ERROR"
      violation_message: "Operational changes must reference certified baseline lineage (LC08 → LC10)"
      remediation: "Add baseline lineage trace: LC08 certification → LC10 production → LC11/LC12/LC13 operations"
      baseline_lineage:
        path: "LC08 (Type Certificate) → LC10 (PBL) → LC11 (OPS Config) → LC12/LC13 (MRO/Source Data)"
        requirement: "All operational changes must trace back to type-certified configuration"

# =============================================================================
# GenLM Deterministic Run Contract
# Ensures reproducibility and traceability in AI-driven generation
# =============================================================================

genlm_run_contract:
  description: "Deterministic execution contract for GenLM-driven content generation"
  authority: "ASIT"
  enforcement: "mandatory"

  determinism:
    model_pin:
      requirement: "required"
      description: "Model version must be pinned (e.g., gpt-4-0125-preview)"
      enforcement: "block"

    prompt_pin:
      requirement: "required"
      description: "Prompt template must be versioned and pinned"
      enforcement: "block"

    policy_pin:
      requirement: "required"
      description: "Policy/instruction file must be versioned and pinned"
      enforcement: "block"

    temperature:
      requirement: "0.0"
      description: "Temperature must be 0.0 for deterministic output"
      enforcement: "block"

    top_p:
      requirement: "1.0"
      description: "Top-p must be 1.0 for deterministic sampling"
      enforcement: "block"

    seed:
      requirement: "required"
      description: "Random seed must be set for reproducibility"
      enforcement: "block"

  input_minimum:
    description: "Minimum required inputs for any GenLM run"
    required_fields:
      - "lc_code"
      - "canonical_phase_name"
      - "baseline_context"
      - "package_type"
      - "ata_or_subdomain"
      - "effectivity"
    validation: "All fields must be populated before generation"

  hard_fail_conditions:
    description: "Conditions that cause immediate generation failure"
    conditions:
      - condition: "noncanonical_lc_name"
        message: "Phase name does not match canonical registry"
        gate: "A2_PHASE_NAME_CANONICAL"

      - condition: "package_outside_phase"
        message: "Package type not allowed in this phase"
        gate: "A3_PACKAGE_TYPE_ALLOWED"

      - condition: "baseline_misplacement"
        message: "Baseline produced in wrong phase"
        gate: "B1/B2/B3_BASELINE_EXCLUSIVITY"

      - condition: "missing_trace_parent"
        message: "Required upstream trace link missing"
        gate: "C1/C2/C3_TRACE_REQUIREMENTS"

# =============================================================================
# Gate Execution Logic
# =============================================================================

gate_execution:
  sequence:
    - group: "Gate Group A"
      gates: ["A1", "A2", "A3", "A4"]
      description: "Integrity checks - structural validity"

    - group: "Gate Group B"
      gates: ["B1", "B2", "B3", "B4"]
      description: "Baseline checks - production and promotion rules"

    - group: "Gate Group C"
      gates: ["C1", "C2", "C3"]
      description: "Certification continuity - traceability and compliance"

  execution_rules:
    - "Gates execute sequentially in order: Group A → Group B → Group C"
    - "First failure aborts execution and reports violation"
    - "All gates in a group must pass before proceeding to next group"
    - "Critical violations halt all downstream processing"
    - "Error violations log and escalate for review"

  reporting:
    format: "JSON"
    required_fields:
      - "gate_id"
      - "gate_name"
      - "status"
      - "violation_severity"
      - "violation_message"
      - "timestamp"
      - "context"

    log_retention: "7 years (certification requirement)"

# =============================================================================
# Audit and Compliance
# =============================================================================

audit:
  requirement: "All gate executions must be logged"
  log_format: "{timestamp} | GATE {gate_id} | {gate_name} | {status} | {context}"
  retention_period: "7 years minimum"
  compliance_standard: "DO-178C, ARP4754A"

# =============================================================================
# End of TLI Gate Rulebook
# =============================================================================
