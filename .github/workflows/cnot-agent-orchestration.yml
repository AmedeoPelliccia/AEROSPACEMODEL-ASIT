name: CNOT Agent Orchestration

# This workflow demonstrates CNOT-gate agent orchestration for lifecycle transitions
# as described in docs/CNOT_AGENT_LIFECYCLE_ARCHITECTURE.md

on:
  workflow_dispatch:
    inputs:
      agent_id:
        description: 'Agent ID to execute'
        required: true
        type: choice
        options:
          - AGENT-DESIGN-VERIFY-001
          - AGENT-VERIFY-CERT-001
          - AGENT-OPS-MONITOR-001
      
      component_id:
        description: 'Component ID'
        required: true
        type: string
      
      baseline_id:
        description: 'Baseline ID (e.g., FBL-2026-Q1-003)'
        required: true
        type: string
      
      contract_id:
        description: 'Contract ID (e.g., KITDM-CTR-LM-CSDB_ATA27)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Load and validate agent configuration
  load-agent-config:
    name: Load Agent Configuration
    runs-on: ubuntu-latest
    
    outputs:
      agent_name: ${{ steps.parse-config.outputs.agent_name }}
      lifecycle_transition: ${{ steps.parse-config.outputs.lifecycle_transition }}
      num_gates: ${{ steps.parse-config.outputs.num_gates }}
      num_actions: ${{ steps.parse-config.outputs.num_actions }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Parse agent configuration
        id: parse-config
        run: |
          python << 'EOPYTHON'
          import yaml
          import sys
          from pathlib import Path
          
          agent_id = "${{ inputs.agent_id }}"
          
          # Find agent config file
          config_file = Path(f"templates/agents/{agent_id.lower().replace('agent-', '').replace('-001', '')}_agent.yaml")
          
          if not config_file.exists():
            print(f"Agent configuration not found: {config_file}")
            sys.exit(1)
          
          with open(config_file) as f:
            config = yaml.safe_load(f)
          
          agent_config = config['cnot_agent']
          
          # Output configuration
          print(f"agent_name={agent_config['name']}")
          print(f"lifecycle_transition={agent_config['lifecycle_transition']['from']}_to_{agent_config['lifecycle_transition']['to']}")
          print(f"num_gates={len(agent_config.get('gates', []))}")
          print(f"num_actions={len(agent_config.get('marketplace_actions', [])) + len(agent_config.get('internal_actions', []))}")
          EOPYTHON
      
      - name: Display agent information
        run: |
          echo "Agent ID: ${{ inputs.agent_id }}"
          echo "Agent Name: ${{ steps.parse-config.outputs.agent_name }}"
          echo "Lifecycle Transition: ${{ steps.parse-config.outputs.lifecycle_transition }}"
          echo "Number of Gates: ${{ steps.parse-config.outputs.num_gates }}"
          echo "Number of Actions: ${{ steps.parse-config.outputs.num_actions }}"

  # Job 2: Execute CNOT gates
  execute-gates:
    name: Execute CNOT Gates
    runs-on: ubuntu-latest
    needs: load-agent-config
    
    outputs:
      gates_passed: ${{ steps.execute-chain.outputs.gates_passed }}
      blocked_by: ${{ steps.execute-chain.outputs.blocked_by }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Execute CNOT gate chain
        id: execute-chain
        run: |
          python << 'EOPYTHON'
          from aerospacemodel.agents import create_agent_from_yaml
          from pathlib import Path
          import json
          
          agent_id = "${{ inputs.agent_id }}"
          
          # Find agent config
          config_file = Path(f"templates/agents/{agent_id.lower().replace('agent-', '').replace('-001', '')}_agent.yaml")
          
          # Create agent
          agent = create_agent_from_yaml(str(config_file))
          
          # Prepare context
          context = {
              "component_id": "${{ inputs.component_id }}",
              "contract": {
                  "contract_id": "${{ inputs.contract_id }}",
                  "status": "ACTIVE"
              },
              "baseline": {
                  "baseline_id": "${{ inputs.baseline_id }}",
                  "state": "APPROVED"
              },
              "execution_authority": "STK_CM",
              "brex_result": {
                  "success": True,
                  "final_action": "ALLOW",
                  "escalation_required": False
              },
              "trace_data": {
                  "total_required": 100,
                  "total_linked": 100
              },
              "safety_impact": {
                  "is_safety_critical": False,
                  "safety_level": "NONE"
              }
          }
          
          # Execute agent
          result = agent.execute(context)
          
          # Output results
          print(f"gates_passed={result['success']}")
          if not result['success']:
              print(f"blocked_by={result.get('blocked_by', 'unknown')}")
          
          # Save full result
          with open('agent_result.json', 'w') as f:
              json.dump(result, f, indent=2)
          
          print("\n=== Agent Execution Result ===")
          print(json.dumps(result, indent=2))
          EOPYTHON
      
      - name: Upload agent result
        uses: actions/upload-artifact@v4
        with:
          name: agent-result-${{ github.run_id }}
          path: agent_result.json
          retention-days: 90

  # Job 3: Execute marketplace actions (only if gates passed)
  execute-marketplace-actions:
    name: Execute Marketplace Actions
    runs-on: ubuntu-latest
    needs: execute-gates
    if: needs.execute-gates.outputs.gates_passed == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download agent result
        uses: actions/download-artifact@v4
        with:
          name: agent-result-${{ github.run_id }}
      
      - name: Display queued actions
        run: |
          python << 'EOPYTHON'
          import json
          
          with open('agent_result.json') as f:
              result = json.load(f)
          
          print("=== Queued Marketplace Actions ===")
          for action in result.get('action_results', []):
              if action['action_type'] == 'marketplace':
                  print(f"\nAction: {action['action_name']}")
                  print(f"Status: {action['status']}")
                  print(f"Source: {action.get('action')}")
          EOPYTHON
      
      # Note: In a real implementation, these would be actual marketplace actions
      # For demonstration, we log the actions that would be executed
      
      - name: Simulate SBOM Generation
        run: |
          echo "Would execute: anchore/sbom-action@v0"
          echo "Parameters: format=spdx-json"
          mkdir -p artifacts
          echo '{"sbom": "simulated"}' > artifacts/sbom.json
      
      - name: Upload simulated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: marketplace-artifacts-${{ github.run_id }}
          path: artifacts/
          retention-days: 90

  # Job 4: Generate provenance
  generate-provenance:
    name: Generate Provenance
    runs-on: ubuntu-latest
    needs: [execute-gates, execute-marketplace-actions]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download agent result
        uses: actions/download-artifact@v4
        with:
          name: agent-result-${{ github.run_id }}
      
      - name: Generate provenance vector
        run: |
          python << 'EOPYTHON'
          import json
          from datetime import datetime
          
          with open('agent_result.json') as f:
              result = json.load(f)
          
          provenance = result.get('provenance', {})
          
          # Enhance provenance with workflow context
          provenance['workflow'] = {
              'run_id': '${{ github.run_id }}',
              'run_number': '${{ github.run_number }}',
              'actor': '${{ github.actor }}',
              'repository': '${{ github.repository }}',
              'ref': '${{ github.ref }}'
          }
          
          # Save provenance
          with open('provenance.json', 'w') as f:
              json.dump(provenance, f, indent=2)
          
          print("=== Provenance Vector Generated ===")
          print(json.dumps(provenance, indent=2))
          EOPYTHON
      
      - name: Upload provenance
        uses: actions/upload-artifact@v4
        with:
          name: provenance-${{ github.run_id }}
          path: provenance.json
          retention-days: 365  # Keep provenance for 1 year

  # Job 5: Summary report
  summary:
    name: Execution Summary
    runs-on: ubuntu-latest
    needs: [load-agent-config, execute-gates, execute-marketplace-actions, generate-provenance]
    if: always()
    
    steps:
      - name: Download agent result
        uses: actions/download-artifact@v4
        with:
          name: agent-result-${{ github.run_id }}
      
      - name: Generate summary
        run: |
          python << 'EOPYTHON'
          import json
          
          with open('agent_result.json') as f:
              result = json.load(f)
          
          print("\n" + "="*60)
          print("CNOT AGENT EXECUTION SUMMARY")
          print("="*60)
          
          print(f"\nAgent: {result['agent_id']}")
          print(f"Lifecycle Transition: {result['lifecycle_transition']}")
          print(f"Success: {result['success']}")
          
          if result['success']:
              print("\n✓ All gates passed")
              print(f"✓ {len(result['action_results'])} actions executed")
              print(f"✓ {len(result['artifacts'])} artifacts generated")
          else:
              print(f"\n✗ Blocked by gate: {result.get('blocked_by', 'unknown')}")
          
          print("\nGate Results:")
          for gate in result['gate_results']:
              status = "✓" if gate['passed'] else "✗"
              print(f"  {status} {gate['gate']}: {gate['message']}")
          
          print("\n" + "="*60)
          EOPYTHON
      
      - name: Create job summary
        run: |
          python << 'EOPYTHON'
          import json
          import os
          
          with open('agent_result.json') as f:
              result = json.load(f)
          
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'w') as f:
              f.write("## CNOT Agent Execution Summary\n\n")
              f.write(f"**Agent:** {result['agent_id']}\n\n")
              f.write(f"**Transition:** {result['lifecycle_transition']}\n\n")
              f.write(f"**Status:** {'✅ Success' if result['success'] else '❌ Failed'}\n\n")
              
              f.write("### Gate Results\n\n")
              for gate in result['gate_results']:
                  status = "✅" if gate['passed'] else "❌"
                  f.write(f"- {status} **{gate['gate']}**: {gate['message']}\n")
              
              if result['success']:
                  f.write("\n### Actions Executed\n\n")
                  for action in result['action_results']:
                      f.write(f"- **{action['action_name']}** ({action['action_type']})\n")
          EOPYTHON
