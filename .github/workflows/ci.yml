name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run ruff linter
        run: |
          ruff check src/ ASIGT/ --output-format=github
        continue-on-error: true
      
      - name: Run mypy type checker
        run: |
          mypy src/ --ignore-missing-imports
        continue-on-error: true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run pytest with coverage
        run: |
          if [ -d "tests" ]; then
            pytest --cov=src/aerospacemodel --cov-report=xml --cov-report=term
          else
            echo "No tests directory found - skipping tests"
          fi
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.11' && always()
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

  brex-validation:
    name: BREX Decision Engine Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Validate BREX rules structure
        run: |
          python -c "
          import yaml
          from pathlib import Path
          
          brex_files = list(Path('ASIGT/brex').glob('*.yaml'))
          print(f'Found {len(brex_files)} BREX files')
          
          for brex_file in brex_files:
              print(f'Validating {brex_file}...')
              with open(brex_file) as f:
                  data = yaml.safe_load(f)
                  if data:
                      print(f'  ✓ Valid YAML: {brex_file.name}')
                  else:
                      print(f'  ⚠ Empty or invalid: {brex_file.name}')
          
          print('BREX validation complete')
          "
      
      - name: Test BREX Decision Engine import
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'ASIGT')
          from brex.brex_decision_engine import BREXDecisionEngine, BREXDecisionAction
          print('✓ BREX Decision Engine imported successfully')
          "

  contract-validation:
    name: Contract Governance Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema
      
      - name: Validate contract YAML files
        run: |
          python -c "
          import yaml
          from pathlib import Path
          
          contract_files = list(Path('ASIT/CONTRACTS').rglob('*.yaml'))
          print(f'Found {len(contract_files)} contract files')
          
          errors = []
          for contract_file in contract_files:
              try:
                  with open(contract_file) as f:
                      data = yaml.safe_load(f)
                      if data:
                          print(f'  ✓ {contract_file}')
                      else:
                          print(f'  ⚠ Empty: {contract_file}')
              except Exception as e:
                  errors.append(f'{contract_file}: {e}')
                  print(f'  ✗ {contract_file}: {e}')
          
          if errors:
              print(f'\n❌ {len(errors)} validation errors found')
              exit(1)
          else:
              print(f'\n✓ All {len(contract_files)} contract files valid')
          "
      
      - name: Check contract ID format compliance
        run: |
          python -c "
          import re
          import yaml
          from pathlib import Path
          
          # Expected format: KITDM-CTR-{CATEGORY}-{TARGET}
          contract_id_pattern = re.compile(r'^KITDM-CTR-[A-Z]+-[A-Z0-9_]+$')
          
          active_contracts = list(Path('ASIT/CONTRACTS/active').glob('*.yaml'))
          
          if not active_contracts:
              print('No active contracts found - skipping ID validation')
              exit(0)
          
          for contract_file in active_contracts:
              with open(contract_file) as f:
                  data = yaml.safe_load(f)
                  if data and 'contract_id' in data:
                      contract_id = data['contract_id']
                      if contract_id_pattern.match(contract_id):
                          print(f'  ✓ {contract_id}')
                      else:
                          print(f'  ✗ Invalid ID format: {contract_id}')
          "

  schema-check:
    name: S1000D Schema Reference Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check S1000D schema files
        run: |
          if [ -d "schemas" ]; then
            echo "Schemas directory found"
            find schemas -name "*.xsd" -o -name "*.dtd" | head -10
          else
            echo "⚠ No schemas directory - call for human in the loop to provide schema validation"
          fi
      
      - name: Verify ATA chapter alignment in templates
        run: |
          python -c "
          from pathlib import Path
          import re
          
          # Check templates for ATA references
          template_files = list(Path('templates').rglob('*.xml')) + list(Path('templates').rglob('*.jinja2'))
          
          if not template_files:
              print('No template files found')
              exit(0)
          
          print(f'Checking {len(template_files)} template files for ATA references...')
          
          ata_pattern = re.compile(r'ATA[\s-]*(\d{2})')
          
          for template_file in template_files:
              try:
                  content = template_file.read_text()
                  matches = ata_pattern.findall(content)
                  if matches:
                      chapters = set(matches)
                      print(f'  {template_file.name}: ATA chapters {chapters}')
              except Exception as e:
                  print(f'  ⚠ Could not read {template_file}: {e}')
          
          print('ATA alignment check complete')
          "
