name: Release Pipeline

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Python Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: |
          python -m build
      
      - name: Check package
        run: |
          twine check dist/*
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 30

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-creatordate | sed -n '2p')
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          echo "Generating changelog from ${PREVIOUS_TAG} to ${CURRENT_TAG}"
          
          # Generate changelog
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${CURRENT_TAG})
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..${CURRENT_TAG})
          fi
          
          # Save changelog
          echo "${CHANGELOG}" > CHANGELOG.txt
          
          echo "Changelog generated:"
          cat CHANGELOG.txt
      
      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.txt
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build, generate-changelog]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      
      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
      
      - name: Create Release Notes
        run: |
          cat << EOF > RELEASE_NOTES.md
          # AEROSPACEMODEL v${{ steps.version.outputs.VERSION }}
          
          ## Release Information
          
          - **Version:** ${{ steps.version.outputs.VERSION }}
          - **Release Date:** $(date +%Y-%m-%d)
          - **Tag:** ${GITHUB_REF#refs/tags/}
          
          ## Changes
          
          $(cat CHANGELOG.txt)
          
          ## Installation
          
          \`\`\`bash
          pip install aerospacemodel==${{ steps.version.outputs.VERSION }}
          \`\`\`
          
          Or download the wheel file from the assets below.
          
          ## Documentation
          
          - [README](https://github.com/AmedeoPelliccia/AEROSPACEMODEL/blob/main/README.md)
          - [S1000D Documentation](https://github.com/AmedeoPelliccia/AEROSPACEMODEL/tree/main/docs)
          
          ## Compliance
          
          - ✅ S1000D Issue 5.0 compliant
          - ✅ ATA iSpec 2200 aligned
          - ✅ DO-178C/ARP4754A traceable
          - ✅ BREX-governed transformations
          
          EOF
          
          cat RELEASE_NOTES.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          files: |
            dist/*
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    name: Publish to PyPI (Optional)
    needs: [create-release]
    runs-on: ubuntu-latest
    if: github.repository == 'AmedeoPelliccia/AEROSPACEMODEL' && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
        continue-on-error: true
      
      - name: Note about PyPI publishing
        run: |
          echo "PyPI publishing attempted (requires PYPI_API_TOKEN secret)"
          echo "If this step failed, the release is still available on GitHub"
