# =============================================================================
# UNIFIED TEKNIA TOKEN SYSTEM (UTTS) — BREX Rule Set
# BREX Profile: N-STD-UTTS-01-BREX-001
# Version: 0.1.0
# =============================================================================
#
# PURPOSE:
#   Define the authoritative BREX decision rules that govern UTTS operations:
#   token creation, Φ transformation, ledger recording, and lineage
#   verification across the MTL₁/MTL₂/MTL₃ stack.
#
# AUTHORITY: ASIT (Aircraft Systems Information Transponder)
# COMPLIANCE: S1000D 5.0, DO-178C, ARP4754A, ARP4761, EU AI Act, EASA Part 21
#
# =============================================================================

# -----------------------------------------------------------------------------
# METADATA
# -----------------------------------------------------------------------------
metadata:
  brex_id: "N-STD-UTTS-01-BREX-001"
  title: "Unified Teknia Token System BREX Rule Set"
  version: "0.1.0"
  status: "DRAFT"
  classification: "Governance Specification"

  created_date: "2026-02-20"
  effective_date: "2026-02-20"

  parent_authority: "ASIT-BREX-MASTER-001"
  standard_reference: "N-STD-UTTS-01 v0.1.0"

  compliance:
    - "S1000D Issue 5.0"
    - "DO-178C"
    - "ARP4754A"
    - "ARP4761"
    - "EU AI Act"
    - "EASA Part 21"
    - "GAIA-X"

  determinism_level: "strict"

# -----------------------------------------------------------------------------
# STRUCTURE RULES
# -----------------------------------------------------------------------------
structure_rules:
  - id: "UTTS-STRUCT-001"
    condition: "All UTTS content MUST be classified under ATA 96 or ATA 98 domain"
    enforcement: "block"
    message: "UTTS content requires ATA 96 or ATA 98 domain classification"

  - id: "UTTS-STRUCT-002"
    condition: "Every ledger entry MUST contain all required fields"
    enforcement: "block"
    required_fields:
      - "entry_id"
      - "timestamp"
      - "event_type"
      - "token_id"
      - "token_version"
      - "actor"
      - "payload_hash"
      - "previous_hash"
      - "authority_signature"
    message: "Ledger entry missing required fields"

  - id: "UTTS-STRUCT-003"
    condition: "event_type MUST be from the approved taxonomy"
    enforcement: "block"
    allowed_types:
      - "TOKEN_CREATE"
      - "TOKEN_UPDATE"
      - "TOKEN_PROMOTE"
      - "TOKEN_DEPRECATE"
      - "TOKEN_RETIRE"
      - "TRANSFORM_PHI"
      - "GATE_PASS"
      - "GATE_FAIL"
      - "BASELINE_FREEZE"
      - "AUTHORITY_SIGN"
    message: "Unknown event type — must be from UTTS taxonomy"

# -----------------------------------------------------------------------------
# LEDGER INTEGRITY RULES
# -----------------------------------------------------------------------------
ledger_rules:
  - id: "UTTS-LEDGER-001"
    condition: "Every ledger entry.previous_hash MUST equal SHA-256 of preceding entry"
    enforcement: "block"
    message: "Hash-chain integrity violation detected"

  - id: "UTTS-LEDGER-002"
    condition: "Ledger is append-only; no entry may be deleted or modified"
    enforcement: "block"
    message: "Append-only constraint violated"

  - id: "UTTS-LEDGER-003"
    condition: "BASELINE_FREEZE entries require ASIT authority signature"
    enforcement: "block"
    message: "Baseline freeze requires authority signature"

  - id: "UTTS-LEDGER-004"
    condition: "Certification-phase entries (LC08) cannot be altered after authority signature"
    enforcement: "block"
    message: "Post-signature certification entries are immutable"

# -----------------------------------------------------------------------------
# TRANSFORMATION RULES
# -----------------------------------------------------------------------------
transformation_rules:
  - id: "UTTS-PHI-001"
    condition: "Every Φ transformation MUST have an active ASIT-approved contract"
    enforcement: "block"
    message: "Transformation requires approved contract"

  - id: "UTTS-PHI-002"
    condition: "Φ operator MUST be deterministic (same inputs → same outputs)"
    enforcement: "block"
    message: "Non-deterministic transformation detected"

  - id: "UTTS-PHI-003"
    condition: "Every Φ transformation MUST produce a TRANSFORM_PHI ledger entry"
    enforcement: "block"
    message: "Transformation must be ledgered"

  - id: "UTTS-PHI-004"
    condition: "transformation_class MUST be from the approved taxonomy"
    enforcement: "block"
    allowed_classes:
      - "DOMAIN_XFER"
      - "LC_PROMOTE"
      - "LAYER_COMPOSE"
      - "SEMANTIC_MAP"
    message: "Unknown transformation class"

# -----------------------------------------------------------------------------
# TRACEABILITY RULES
# -----------------------------------------------------------------------------
traceability_rules:
  - id: "UTTS-TRACE-001"
    condition: "Every token MUST have a complete lineage chain in the ledger"
    enforcement: "block"
    message: "Token lineage incomplete — all transformations must be ledgered"

  - id: "UTTS-TRACE-002"
    condition: "Certification evidence chains MUST be verifiable end-to-end"
    enforcement: "block"
    message: "Certification evidence chain broken"

  - id: "UTTS-TRACE-003"
    condition: "DPP integration events MUST be cross-referenced in both systems"
    enforcement: "warn"
    message: "DPP cross-reference missing"

# -----------------------------------------------------------------------------
# SAFETY RULES
# -----------------------------------------------------------------------------
safety_rules:
  - id: "UTTS-SAFE-001"
    condition: "Ledger append/verify module changes require STK_SAF review"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Ledger core module changes require safety review"

  - id: "UTTS-SAFE-002"
    condition: "Authority signature validation rule changes require STK_SAF approval"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Signature validation changes require safety approval"

  - id: "UTTS-SAFE-003"
    condition: "Hash-chain integrity verification logic changes require STK_SAF review"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Hash-chain verification changes require safety review"

# -----------------------------------------------------------------------------
# GOVERNANCE RULES
# -----------------------------------------------------------------------------
governance_rules:
  - id: "UTTS-GOV-001"
    condition: "Ledger write access requires ASIT authority signature"
    enforcement: "block"
    message: "Unauthorized ledger write attempt"

  - id: "UTTS-GOV-002"
    condition: "Token lineage checks at Gate Group D require STK_SAF sign-off"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Gate Group D token lineage check requires safety sign-off"

  - id: "UTTS-GOV-003"
    condition: "Labour continuity constraint applies to UTTS automation"
    enforcement: "escalate"
    escalation_target: "STK_OPS"
    message: "Labour continuity constraint applies"

# -----------------------------------------------------------------------------
# LIFECYCLE RULES
# -----------------------------------------------------------------------------
lifecycle_rules:
  - id: "UTTS-LC-001"
    condition: "Token promotion requires all acceptance gates passing in ledger"
    enforcement: "block"
    message: "Cannot promote token with failing gates"

  - id: "UTTS-LC-002"
    condition: "Baseline freeze requires prior ledger integrity verification"
    enforcement: "block"
    message: "Hash-chain must be verified before baseline freeze"

  - id: "UTTS-LC-003"
    condition: "End-of-life (LC14) requires final ledger snapshot and DPP closure entry"
    enforcement: "block"
    message: "LC14 requires final ledger snapshot"

# -----------------------------------------------------------------------------
# ESCALATION PROCEDURES
# -----------------------------------------------------------------------------
escalation_procedures:
  safety_content:
    trigger: "UTTS-SAFE-001 or UTTS-SAFE-002 or UTTS-SAFE-003"
    escalation_target: "STK_SAF"
    timeout: "72 hours"

  governance_override:
    trigger: "UTTS-GOV-002 or UTTS-GOV-003"
    escalation_target: "CCB"
    timeout: "5 business days"

  undefined_condition:
    trigger: "No matching rule"
    escalation_target: "STK_CM"
    action: "HALT and wait for rule definition"

# -----------------------------------------------------------------------------
# AUDIT LOG
# -----------------------------------------------------------------------------
audit_requirements:
  format: "{timestamp} | RULE {rule_id} | {rule_name} | {status} | {context}"
  required_entries:
    - "Ledger entry validation"
    - "Hash-chain integrity check"
    - "Transformation contract validation"
    - "Authority signature verification"
    - "Token lineage verification"
    - "Safety impact assessment (if applicable)"
    - "DPP integration cross-reference check"
  retention: "7 years minimum (certification)"

# -----------------------------------------------------------------------------
# SUMMARY
# -----------------------------------------------------------------------------
summary:
  total_structure_rules: 3
  total_ledger_rules: 4
  total_transformation_rules: 4
  total_traceability_rules: 3
  total_safety_rules: 3
  total_governance_rules: 3
  total_lifecycle_rules: 3
