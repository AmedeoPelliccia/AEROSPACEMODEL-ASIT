# =============================================================================
# UNIFIED TEKNIA TOKEN SYSTEM (UTTS) — BREX Rule Set
# BREX Profile: N-STD-UTTS-01-BREX-001
# Version: 0.1.0
# =============================================================================
#
# PURPOSE:
#   Define the authoritative BREX decision rules that govern any system
#   implementing UTTS Modification Track Lookup.
#
# AUTHORITY: ASIT (Aircraft Systems Information Transponder)
# COMPLIANCE: S1000D 5.0, DO-178C, ARP4754A, ARP4761, EU AI Act
#
# =============================================================================
# -----------------------------------------------------------------------------
# METADATA
# -----------------------------------------------------------------------------
metadata:
  brex_id: "N-STD-UTTS-01-BREX-001"
  title: "Unified Teknia Token System BREX Rule Set"
  version: "0.1.0"
  status: "DRAFT"
  classification: "Governance Specification"

  created_date: "2026-02-20"
  effective_date: "2026-02-20"

  parent_authority: "ASIT-BREX-MASTER-001"
  standard_reference: "N-STD-UTTS-01 v0.1.0"

  compliance:
    - "S1000D Issue 5.0"
    - "DO-178C"
    - "ARP4754A"
    - "ARP4761"
    - "EU AI Act"
    - "EASA Part 21"
    - "GAIA-X"

  determinism_level: "strict"

# -----------------------------------------------------------------------------
# STRUCTURE RULES
# -----------------------------------------------------------------------------
structure_rules:
  - id: "UTTS-STRUCT-001"
    condition: "Every modification event MUST have a mod_id"
    enforcement: "block"
    pattern: "^MOD-[0-9]{6}$"
    message: "Modification event missing mod_id or wrong format (must be MOD-NNNNNN)"

  - id: "UTTS-STRUCT-002"
    condition: "mod_id MUST follow pattern MOD-NNNNNN"
    enforcement: "block"
    pattern: "^MOD-[0-9]{6}$"
    message: "mod_id does not match required pattern MOD-NNNNNN"

  - id: "UTTS-STRUCT-003"
    condition: "change_type MUST be from the approved taxonomy"
    enforcement: "block"
    allowed_change_types:
      - "constraint_update"
      - "parameter_revision"
      - "evidence_addition"
      - "procedure_amendment"
      - "regulatory_realignment"
      - "status_transition"
    message: "Unknown change_type — must be from UTTS approved taxonomy"

# -----------------------------------------------------------------------------
# INTEGRITY RULES
# -----------------------------------------------------------------------------
integrity_rules:
  - id: "UTTS-INT-001"
    condition: "Every modification event MUST provide previous_hash and new_hash"
    enforcement: "block"
    message: "Hash chain broken — previous_hash or new_hash missing"

  - id: "UTTS-INT-002"
    condition: "new_hash MUST differ from previous_hash"
    enforcement: "block"
    message: "new_hash equals previous_hash — no actual change recorded"

  - id: "UTTS-INT-003"
    condition: "Hash algorithm MUST be SHA3-512"
    enforcement: "block"
    allowed_algorithms:
      - "SHA3-512"
    message: "Non-approved hash algorithm — only SHA3-512 is accepted"

  - id: "UTTS-INT-004"
    condition: "Hash chain formula: Hash(Tᵢ) = H(Tᵢ_data + Hash(Tᵢ₋₁)) must be verifiable"
    enforcement: "block"
    message: "Hash chain integrity violation detected"

# -----------------------------------------------------------------------------
# GOVERNANCE RULES
# -----------------------------------------------------------------------------
governance_rules:
  - id: "UTTS-GOV-001"
    condition: "Every modification event MUST carry an ASIT-recognized authority node"
    enforcement: "block"
    message: "Modification event missing or unrecognized authority"

  - id: "UTTS-GOV-002"
    condition: "LC phase regression requires explicit ECR/ECO authorization"
    enforcement: "block"
    message: "Cannot regress LC phase without authorized ECR/ECO"

  - id: "UTTS-GOV-003"
    condition: "Technical changes (constraint_update, parameter_revision) MUST reference at least one regulation or SC"
    enforcement: "block"
    message: "Technical change missing regulatory anchor — orphan engineering not permitted"

  - id: "UTTS-GOV-004"
    condition: "Every modification event MUST declare impact_scope (empty list is acceptable for isolated changes)"
    enforcement: "block"
    message: "Modification event missing impact_scope declaration"

  - id: "UTTS-GOV-005"
    condition: "BASELINED tokens require CCB approval for any modification"
    enforcement: "require_approval"
    message: "Modification to BASELINED token requires CCB change control"

  - id: "UTTS-STRUCT-002"
    condition: "Every ledger entry MUST contain all required fields"
    enforcement: "block"
    required_fields:
      - "entry_id"
      - "timestamp"
      - "event_type"
      - "token_id"
      - "token_version"
      - "actor"
      - "payload_hash"
      - "previous_hash"
      - "authority_signature"
    message: "Ledger entry missing required fields"

  - id: "UTTS-STRUCT-003"
    condition: "event_type MUST be from the approved taxonomy"
    enforcement: "block"
    allowed_types:
      - "TOKEN_CREATE"
      - "TOKEN_UPDATE"
      - "TOKEN_PROMOTE"
      - "TOKEN_DEPRECATE"
      - "TOKEN_RETIRE"
      - "TRANSFORM_PHI"
      - "GATE_PASS"
      - "GATE_FAIL"
      - "BASELINE_FREEZE"
      - "AUTHORITY_SIGN"
    message: "Unknown event type — must be from UTTS taxonomy"

# -----------------------------------------------------------------------------
# LEDGER INTEGRITY RULES
# -----------------------------------------------------------------------------
ledger_rules:
  - id: "UTTS-LEDGER-001"
    condition: "Every ledger entry.previous_hash MUST equal SHA-256 of preceding entry"
    enforcement: "block"
    message: "Hash-chain integrity violation detected"

  - id: "UTTS-LEDGER-002"
    condition: "Ledger is append-only; no entry may be deleted or modified"
    enforcement: "block"
    message: "Append-only constraint violated"

  - id: "UTTS-LEDGER-003"
    condition: "BASELINE_FREEZE entries require ASIT authority signature"
    enforcement: "block"
    message: "Baseline freeze requires authority signature"

  - id: "UTTS-LEDGER-004"
    condition: "Certification-phase entries (LC08) cannot be altered after authority signature"
    enforcement: "block"
    message: "Post-signature certification entries are immutable"

# -----------------------------------------------------------------------------
# TRANSFORMATION RULES
# -----------------------------------------------------------------------------
transformation_rules:
  - id: "UTTS-PHI-001"
    condition: "Every Φ transformation MUST have an active ASIT-approved contract"
    enforcement: "block"
    message: "Transformation requires approved contract"

  - id: "UTTS-PHI-002"
    condition: "Φ operator MUST be deterministic (same inputs → same outputs)"
    enforcement: "block"
    message: "Non-deterministic transformation detected"

  - id: "UTTS-PHI-003"
    condition: "Every Φ transformation MUST produce a TRANSFORM_PHI ledger entry"
    enforcement: "block"
    message: "Transformation must be ledgered"

  - id: "UTTS-PHI-004"
    condition: "transformation_class MUST be from the approved taxonomy"
    enforcement: "block"
    allowed_classes:
      - "DOMAIN_XFER"
      - "LC_PROMOTE"
      - "LAYER_COMPOSE"
      - "SEMANTIC_MAP"
    message: "Unknown transformation class"

# -----------------------------------------------------------------------------
# TRACEABILITY RULES
# -----------------------------------------------------------------------------
traceability_rules:
  - id: "UTTS-TRACE-001"
    condition: "Every token MUST have a complete lineage chain in the ledger"
    enforcement: "block"
    message: "Token lineage incomplete — all transformations must be ledgered"

  - id: "UTTS-TRACE-002"
    condition: "Certification evidence chains MUST be verifiable end-to-end"
    enforcement: "block"
    message: "Certification evidence chain broken"

  - id: "UTTS-TRACE-003"
    condition: "DPP integration events MUST be cross-referenced in both systems"
    enforcement: "warn"
    message: "DPP cross-reference missing"

# -----------------------------------------------------------------------------
# SAFETY RULES
# -----------------------------------------------------------------------------
safety_rules:
  - id: "UTTS-SAFE-001"
    condition: "Modifications to safety-critical tokens (DAL A/B) require STK_SAF escalation"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Safety-critical token modification requires human safety approval"

  - id: "UTTS-SAFE-002"
    condition: "EU AI Act high-risk token modifications require conformity assessment update"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "High-risk AI token modification requires updated conformity assessment"

  - id: "UTTS-SAFE-003"
    condition: "If safety-critical gate fails then decision_state must be HOLD, ESCALATE, or REJECT — never implicit ALLOW"
    enforcement: "block"
    message: "Safety gate failure must not resolve to ALLOW"

# -----------------------------------------------------------------------------
# TRACEABILITY RULES
# -----------------------------------------------------------------------------
traceability_rules:
  - id: "UTTS-TRACE-001"
    condition: "Every modification event MUST reference parent_token"
    enforcement: "block"
    message: "Modification event missing parent_token link"

  - id: "UTTS-TRACE-002"
    condition: "justification_ref MUST reference at least one regulation, SC, or ECR for change_type in {constraint_update, parameter_revision, regulatory_realignment}"
    enforcement: "block"
    message: "Technical modification requires regulatory or change control reference"

  - id: "UTTS-TRACE-003"
    condition: "impact_scope entries must be verifiable artifact IDs"
    enforcement: "warn"
    message: "Impact scope entries should reference known artifact IDs"

  - id: "UTTS-TRACE-004"
    condition: "Forward traceability: all downstream impacted artifacts must be re-validated after modification"
    enforcement: "require_approval"
    message: "Impact scope artifacts require re-validation confirmation"
    condition: "Ledger append/verify module changes require STK_SAF review"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Ledger core module changes require safety review"

  - id: "UTTS-SAFE-002"
    condition: "Authority signature validation rule changes require STK_SAF approval"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Signature validation changes require safety approval"

  - id: "UTTS-SAFE-003"
    condition: "Hash-chain integrity verification logic changes require STK_SAF review"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Hash-chain verification changes require safety review"

# -----------------------------------------------------------------------------
# GOVERNANCE RULES
# -----------------------------------------------------------------------------
governance_rules:
  - id: "UTTS-GOV-001"
    condition: "Ledger write access requires ASIT authority signature"
    enforcement: "block"
    message: "Unauthorized ledger write attempt"

  - id: "UTTS-GOV-002"
    condition: "Token lineage checks at Gate Group D require STK_SAF sign-off"
    enforcement: "escalate"
    escalation_target: "STK_SAF"
    message: "Gate Group D token lineage check requires safety sign-off"

  - id: "UTTS-GOV-003"
    condition: "Labour continuity constraint applies to UTTS automation"
    enforcement: "escalate"
    escalation_target: "STK_OPS"
    message: "Labour continuity constraint applies"

# -----------------------------------------------------------------------------
# LIFECYCLE RULES
# -----------------------------------------------------------------------------
lifecycle_rules:
  - id: "UTTS-LC-001"
    condition: "timestamp_utc MUST be present and in ISO 8601 format"
    enforcement: "block"
    pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
    message: "Modification timestamp missing or not in UTC ISO 8601 format"

  - id: "UTTS-LC-002"
    condition: "lc_phase MUST be a valid ASIT lifecycle phase (LC01–LC14)"
    enforcement: "block"
    allowed_phases:
      - "LC01"
      - "LC02"
      - "LC03"
      - "LC04"
      - "LC05"
      - "LC06"
      - "LC07"
      - "LC08"
      - "LC09"
      - "LC10"
      - "LC11"
      - "LC12"
      - "LC13"
      - "LC14"
    message: "lc_phase must be LC01 through LC14"

  - id: "UTTS-LC-003"
    condition: "status_transition change_type MUST follow the allowed state machine"
    enforcement: "block"
    allowed_transitions:
      - from: "DEV"
        to: "VAL"
      - from: "VAL"
        to: "PROMOTED"
      - from: "PROMOTED"
        to: "DEPRECATED"
      - from: "VAL"
        to: "DEV"
    message: "Invalid status transition — not in approved state machine"

# -----------------------------------------------------------------------------
# QUERY RULES
# -----------------------------------------------------------------------------
query_rules:
  - id: "UTTS-QRY-001"
    condition: "All five lookup dimensions (DIM-01 through DIM-05) MUST be supported"
    enforcement: "block"
    required_dimensions:
      - "DIM-01"
      - "DIM-02"
      - "DIM-03"
      - "DIM-04"
      - "DIM-05"
    message: "UTTS implementation missing required lookup dimension"

  - id: "UTTS-QRY-002"
    condition: "Query results MUST be ordered and deterministic for identical inputs"
    enforcement: "block"
    message: "Non-deterministic query output violates UTTS governance"

  - id: "UTTS-QRY-003"
    condition: "Query results MUST include cryptographic verification data"
    enforcement: "block"
    message: "Query results must be cryptographically verifiable"
    condition: "Token promotion requires all acceptance gates passing in ledger"
    enforcement: "block"
    message: "Cannot promote token with failing gates"

  - id: "UTTS-LC-002"
    condition: "Baseline freeze requires prior ledger integrity verification"
    enforcement: "block"
    message: "Hash-chain must be verified before baseline freeze"

  - id: "UTTS-LC-003"
    condition: "End-of-life (LC14) requires final ledger snapshot and DPP closure entry"
    enforcement: "block"
    message: "LC14 requires final ledger snapshot"

# -----------------------------------------------------------------------------
# ESCALATION PROCEDURES
# -----------------------------------------------------------------------------
escalation_procedures:
  safety_content:
    trigger: "UTTS-SAFE-001 or UTTS-SAFE-002"
    escalation_target: "STK_SAF"
    timeout: "72 hours"

  baseline_modification:
    trigger: "UTTS-GOV-005"
    escalation_target: "CCB"
    required_approval:
      - "ECR submission"
      - "Impact assessment"
      - "CCB decision"
    timeout: "5 business days"

  undefined_condition:
    trigger: "No matching BREX rule"
    trigger: "UTTS-SAFE-001 or UTTS-SAFE-002 or UTTS-SAFE-003"
    escalation_target: "STK_SAF"
    timeout: "72 hours"

  governance_override:
    trigger: "UTTS-GOV-002 or UTTS-GOV-003"
    escalation_target: "CCB"
    timeout: "5 business days"

  undefined_condition:
    trigger: "No matching rule"
    escalation_target: "STK_CM"
    action: "HALT and wait for rule definition"

# -----------------------------------------------------------------------------
# AUDIT LOG
# -----------------------------------------------------------------------------
audit_requirements:
  format: "{timestamp} | RULE {rule_id} | {rule_name} | {status} | {context}"
  required_entries:
    - "Hash chain integrity check"
    - "Authority validation"
    - "Regulatory anchor check"
    - "LC phase validation"
    - "Impact scope declaration"
    - "Safety impact assessment (if applicable)"
    - "Ledger entry validation"
    - "Hash-chain integrity check"
    - "Transformation contract validation"
    - "Authority signature verification"
    - "Token lineage verification"
    - "Safety impact assessment (if applicable)"
    - "DPP integration cross-reference check"
  retention: "7 years minimum (certification)"

# -----------------------------------------------------------------------------
# SUMMARY
# -----------------------------------------------------------------------------
summary:
  total_structure_rules: 3
  total_integrity_rules: 4
  total_governance_rules: 5
  total_safety_rules: 3
  total_traceability_rules: 4
  total_lifecycle_rules: 3
  total_query_rules: 3
  total_ledger_rules: 4
  total_transformation_rules: 4
  total_traceability_rules: 3
  total_safety_rules: 3
  total_governance_rules: 3
  total_lifecycle_rules: 3
